<!DOCTYPE html>
<html>
<!--head start-->
  <head>
    <meta charset="UTF-8">
    <title>VoiceToDiscord</title>
  </head>
<!--head end-->
<!--body start-->
  <body>

	  <br>
	
URL:<input type="text" id="txturl" style="background-color:#A0FFA0" onchange="urlchg()">　　
name:<input type="text" id="txtname" style="background-color:#80C0FF" onchange="namechg()">
<br>
<div id="divResult" style="font-size:30px;color:#000000"></div><div id="divResultP" style="font-size:30px;color:#A0A0A0"></div>

 <script src="jquery.js"></script>
 <script>

//const divResult = document.querySelector('#result');
//const divPendingText = document.querySelector('.pendingText');
//const divFinalText = document.querySelector('.finalText');

//document.querySelector('title').text = 'aSR '+currentVe
let finalText = '';
let u1="",u2="",u3="",u4="",u5="";
	 
SpeechRecognition = webkitSpeechRecognition || SpeechRecognition;
const recognition = new SpeechRecognition();
recognition.lang = 'ja-JP';
recognition.interimResults = true;
recognition.continuous = false;

if (localStorage['url'] !== undefined) {
	txturl.value = localStorage['url'];
}
if (localStorage['name'] !== undefined) {
	txtname.value = localStorage['name'];
}
else
{
	txtname.value = "bot";
}

recognition.onresult = (event) => {
    let pendingText = '';
    let bSend=false, bClear=false, bUndo=false;
    
    for (let i = event.resultIndex; i < event.results.length; i++) {
        let transcript = event.results[i][0].transcript;
        if(transcript==="送信")
	{
		bSend=true;
	}
        else if(transcript==="クリア")
	{
		bClear=true;
	}
        else if(transcript==="やり直し")
	{
		bUndo=true;
	}
	else
	{
		if (event.results[i].isFinal) {
		    finalText += transcript;

		}
		else {
            		pendingText = transcript;
        	}
	}
	    
	    
    }
    if(bClear==true)
    {
	    finalText="";
    }
    else
    {
	    if(bUndo==true)
	    {
		    u1=u2;
		    u2=u3;
		    u3=u4;
		    u4=u5;
		    finalText=u1;
	    }
	    else
	    {
		if(bSend==true)
		{
			if(finalText!="")
			{
				localStorage['url'] = txturl.value;
				localStorage['name'] = txtname.value;

				//alert(finalText);
				var link = txturl.value;

				var username = txtname.value;
				var content = finalText;
				var sty1 = 'color:#40e0d0;background:#484b52;';
				console.log("%c Webhook Link:      " + "%s \n" + " Bot Username: " + " %s \n" + " content:  " + " %s \n", sty1, link, username, content);
				if (link==null || link=="",content==null || content=="")
				{
				    alert("すべての欄に記入してください");
				    return false;
				}
				$.post(link, {"content": content, "username": username});
			}
			finalText="";
		}
	    }
    }
    divResult.innerHTML = finalText; //'<div class="finalText" style="color: #'+finalTextColor+';'+strokeTag+'">'+finalText+'</div>';
    //if(!pendingNone) divResult.innerHTML += '<div class="pendingText" style="color: #'+pendingTextColor+';">'+pendingText+'</div>';
	divResultP.innerHTML = pendingText;
	
	if(u1!=finalText)
	{
		u5=u4;
		u4=u3;
		u3=u2;
		u2=u1;
		u1=finalText;
	}
}

recognition.onerror = (e) => {
    console.log('onerror', e)
    if (e.error == 'no-speech') { // 無音
        try { recognition.stop(); } catch (e) {}
        setTimeout(() => {
            try { recognition.start(); } catch (e) {}
        }, 500);

    } else {
        try { recognition.stop(); } catch (e) {}
        setTimeout(() => {
            try { recognition.start(); } catch (e) {}
        }, 500);
    }
}

recognition.onspeechend = (e) => {
    setTimeout(() => {
        try { recognition.start(); } catch (e) {}
    }, 500);
}

function urlchg()
{
	localStorage['url'] = txturl.value;
}
function namechg()
{
	localStorage['name'] = txtname.value;
}

let strokeTag = '';

//if(!strokeNone){
//    strokeTag = '-webkit-text-stroke: '+strokeSize+'px #'+strokeColor+'; text-stroke: '+strokeSize+'px #'+strokeColor+';'
//}

//if(bgColor){
//    document.querySelector('body').style.backgroundColor = '#'+bgColor;
//}

recognition.start();

setInterval(() => {
    try { recognition.start(); } catch (e) {}
}, 2000)

</script>
</body>
</html>

